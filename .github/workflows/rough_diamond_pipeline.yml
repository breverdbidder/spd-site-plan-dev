name: SPD Rough Diamond Pipeline

on:
  schedule:
    - cron: '0 11 * * *'
  workflow_dispatch:
    inputs:
      min_acres:
        description: 'Minimum acres'
        default: '2'
      max_acres:
        description: 'Maximum acres'
        default: '100'
      use_sample:
        description: 'Use sample data (skip API)'
        default: 'false'

env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_KEY }}

jobs:
  rough-diamond-search:
    name: BCPAO Rough Diamond Search
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Deps
        run: pip install pynacl
      
      - name: Run Scorer on Sample Data
        id: scorer
        working-directory: src
        run: |
          python3 << 'PYEOF'
          import sys
          import json
          sys.path.insert(0, '.')
          from models.scoring_model import RoughDiamondScorer
          
          # Use sample West Melbourne/Palm Bay parcels
          sample = [
              {"account": "2835546", "parcelID": "25-36-01-00-00100", "siteAddress": "4500 DAIRY RD, MELBOURNE FL 32904",
               "acreage": 12.5, "taxingDistrict": "UNINCORP DISTRICT 3", "landUseCode": "AGRICULTURAL - GRAZING", 
               "marketValue": 175000, "owners": "BLISS PALM BAY LLC"},
              {"account": "2841001", "parcelID": "26-36-02-00-00050", "siteAddress": "2100 MINTON RD, WEST MELBOURNE FL 32904",
               "acreage": 8.2, "taxingDistrict": "UNINCORP DISTRICT 3", "landUseCode": "VACANT RESIDENTIAL", 
               "marketValue": 95000, "owners": "SMITH FAMILY TRUST"},
              {"account": "2850123", "parcelID": "28-36-15-00-00200", "siteAddress": "5500 BABCOCK ST, PALM BAY FL 32905",
               "acreage": 22.0, "taxingDistrict": "UNINCORP DISTRICT 4", "landUseCode": "AGRICULTURAL - TIMBER", 
               "marketValue": 320000, "owners": "JONES INVESTMENTS"},
              {"account": "2860789", "parcelID": "30-37-05-00-00075", "siteAddress": "1234 MALABAR RD, PALM BAY FL 32907",
               "acreage": 5.5, "taxingDistrict": "UNINCORP DISTRICT 4", "landUseCode": "AGRICULTURAL - PASTURE", 
               "marketValue": 85000, "owners": "COASTAL FARMS LLC"},
              {"account": "2871234", "parcelID": "29-36-22-00-00125", "siteAddress": "8800 ELLIS RD, MELBOURNE FL 32904",
               "acreage": 45.0, "taxingDistrict": "UNINCORP DISTRICT 3", "landUseCode": "AGRICULTURAL - CROPLAND", 
               "marketValue": 550000, "owners": "HERITAGE LAND HOLDINGS"},
          ]
          
          scorer = RoughDiamondScorer()
          scored = scorer.score_parcels(sample)
          
          bid_count = len([p for p in scored if '游릭' in p.get('recommendation', '')])
          review_count = len([p for p in scored if '游리' in p.get('recommendation', '')])
          
          print(f"Scored {len(scored)} parcels: {bid_count} BID, {review_count} REVIEW")
          
          with open('../data/scored_results.json', 'w') as f:
              json.dump({"parcels": scored, "bid_count": bid_count, "review_count": review_count}, f, indent=2)
          
          # Output for GitHub Actions
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"bid_count={bid_count}\n")
              f.write(f"review_count={review_count}\n")
          PYEOF
      
      - name: Generate Summary
        run: |
          echo "## 游댌 Rough Diamond Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| 游릭 BID | ${{ steps.scorer.outputs.bid_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 游리 REVIEW | ${{ steps.scorer.outputs.review_count }} |" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: rough-diamond-${{ github.run_number }}
          path: data/*.json
          retention-days: 30
