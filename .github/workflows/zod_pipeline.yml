name: ZOD Discovery Pipeline

on:
  workflow_dispatch:
    inputs:
      jurisdiction:
        description: 'Target jurisdiction (e.g., Palm Bay, Brevard County)'
        required: true
        default: 'Palm Bay'
        type: string
      target_flu:
        description: 'FLU categories to search (comma-separated: HDR,MDR,MXU)'
        required: true
        default: 'HDR,MDR'
        type: string
      min_acres:
        description: 'Minimum parcel size in acres'
        required: true
        default: '0.5'
        type: string
      max_parcels:
        description: 'Maximum parcels to analyze'
        required: true
        default: '50'
        type: string
  
  schedule:
    # Run weekly on Sundays at 6 AM EST (11 AM UTC)
    - cron: '0 11 * * 0'

env:
  PYTHON_VERSION: '3.11'
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
  GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

jobs:
  zod-discovery:
    name: Run ZOD Discovery
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set workflow parameters
        id: params
        run: |
          # Use inputs or defaults for scheduled runs
          echo "jurisdiction=${{ github.event.inputs.jurisdiction || 'Palm Bay' }}" >> $GITHUB_OUTPUT
          echo "target_flu=${{ github.event.inputs.target_flu || 'HDR,MDR' }}" >> $GITHUB_OUTPUT
          echo "min_acres=${{ github.event.inputs.min_acres || '0.5' }}" >> $GITHUB_OUTPUT
          echo "max_parcels=${{ github.event.inputs.max_parcels || '50' }}" >> $GITHUB_OUTPUT
      
      - name: Run ZOD Discovery
        id: discovery
        run: |
          python -m src.agents.run_zod \
            --jurisdiction "${{ steps.params.outputs.jurisdiction }}" \
            --flu-categories "${{ steps.params.outputs.target_flu }}" \
            --min-acres ${{ steps.params.outputs.min_acres }} \
            --max-parcels ${{ steps.params.outputs.max_parcels }} \
            --output-dir reports/zod
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      
      - name: Upload reports as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zod-reports-${{ github.run_id }}
          path: reports/zod/
          retention-days: 30
      
      - name: Log to Supabase
        if: always()
        run: |
          python -c "
          import os
          import json
          from datetime import datetime
          from supabase import create_client
          
          url = os.environ.get('SUPABASE_URL')
          key = os.environ.get('SUPABASE_KEY')
          
          if url and key:
              client = create_client(url, key)
              
              insight = {
                  'category': 'spd_pipeline',
                  'subcategory': 'zod_discovery',
                  'content': json.dumps({
                      'jurisdiction': '${{ steps.params.outputs.jurisdiction }}',
                      'target_flu': '${{ steps.params.outputs.target_flu }}',
                      'status': '${{ job.status }}',
                      'run_id': '${{ github.run_id }}',
                      'timestamp': datetime.utcnow().isoformat()
                  }),
                  'source': 'github_actions',
                  'confidence': 1.0
              }
              
              client.table('insights').insert(insight).execute()
              print('Logged to Supabase')
          else:
              print('Supabase credentials not available')
          "

  notify-on-high-scores:
    name: Notify on High-Score Opportunities
    runs-on: ubuntu-latest
    needs: zod-discovery
    if: success()
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: zod-reports-${{ github.run_id }}
          path: reports/
      
      - name: Check for A-grade opportunities
        id: check-grades
        run: |
          # Parse reports and check for high scores
          python3 << 'EOF'
          import json
          import glob
          import os
          
          high_score_count = 0
          top_opportunities = []
          
          for report_file in glob.glob('reports/**/*.json', recursive=True):
              with open(report_file) as f:
                  data = json.load(f)
                  
              if 'opportunity_summary' in data:
                  grade = data['opportunity_summary'].get('grade', 'F')
                  if grade in ['A+', 'A']:
                      high_score_count += 1
                      top_opportunities.append({
                          'parcel_id': data['property_identification'].get('parcel_id'),
                          'address': data['property_identification'].get('address'),
                          'grade': grade,
                          'score': data['opportunity_summary'].get('total_score')
                      })
          
          # Output for next steps
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'high_score_count={high_score_count}\n')
              f.write(f'has_opportunities={"true" if high_score_count > 0 else "false"}\n')
          
          if top_opportunities:
              print(f"\nðŸŽ¯ Found {len(top_opportunities)} A-grade opportunities:")
              for opp in top_opportunities:
                  print(f"  - {opp['parcel_id']}: {opp['address']} (Score: {opp['score']}, Grade: {opp['grade']})")
          EOF
      
      - name: Create issue for high-score opportunities
        if: steps.check-grades.outputs.has_opportunities == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const count = '${{ steps.check-grades.outputs.high_score_count }}';
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸŽ¯ ZOD Discovery: ${count} A-Grade Opportunities Found`,
              body: `## Zoning Opportunity Discovery Results
              
              **Run ID:** ${{ github.run_id }}
              **Jurisdiction:** ${{ needs.zod-discovery.outputs.jurisdiction || 'Palm Bay' }}
              
              ### Summary
              Found **${count}** high-scoring (A/A+) zoning opportunities.
              
              ### Next Steps
              1. Review detailed reports in workflow artifacts
              2. Prioritize opportunities by unit upside potential
              3. Schedule pre-application meetings for top candidates
              
              ### Artifacts
              [Download Reports](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `,
              labels: ['zod-discovery', 'high-priority', 'automated']
            });
